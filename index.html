<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temari Oposicions - Cultura General</title>
    <!-- Tus meta tags, links a fuentes, etc. van aquí. Los he omitido por brevedad pero están en tu código original y funcionan bien. -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Montserrat:wght@400;600&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Tu CSS completo va aquí. No lo he modificado, está perfecto. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --text-color: #333333; --background-color: #FAFAFA; --card-background: #ffffff; --primary-color: #1E88E5; --secondary-color: #FF7043; --positive-color: #81C784; --progress-color: #2c974b; --button-bg: #1E88E5; --button-hover: #1976D2; }
        .dark-mode { --text-color: #e0e0e0; --background-color: #121212; --card-background: #1f1f1f; --primary-color: #64B5F6; --secondary-color: #FFB74D; --positive-color: #AED581; --progress-color: #4CAF50; --button-bg: #616161; --button-hover: #424242; }
        body { font-family: 'Open Sans', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; overflow-x: hidden; transition: background-color 0.4s ease, color 0.4s ease; }
        .auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: var(--background-color); text-align: center; padding: 20px; }
        .auth-box { background: var(--card-background); padding: 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); max-width: 400px; width: 100%; border: 1px solid rgba(30, 136, 229, 0.1); }
        .auth-box h2 { font-family: 'Montserrat', sans-serif; font-size: 24px; color: var(--primary-color); margin-bottom: 25px; font-weight: 600; }
        .auth-box input { width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; background: var(--background-color); color: var(--text-color); }
        .auth-box input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 8px rgba(30, 136, 229, 0.2); }
        .auth-box button { width: 100%; padding: 15px; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-size: 18px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease, transform 0.3s ease; }
        .auth-box button:hover { background-color: var(--button-hover); transform: translateY(-2px); }
        .auth-toggle { margin-top: 20px; font-size: 14px; }
        .auth-toggle a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        .main-header { display: none; /* Oculto por defecto */ padding: 30px 20px; text-align: center; border-bottom: 3px solid var(--primary-color); position: sticky; top: 0; z-index: 100; background: var(--background-color); }
        .main-header.show { display: block; }
        .main-title { font-family: 'Lora', serif; font-size: 28px; color: var(--primary-color); }
        .quiz-container { display: none; /* Oculto por defecto */ max-width: 900px; margin: 0 auto; padding: 20px; }
        .quiz-container.show { display: block; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 15px; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #c82333; }
        /* El resto de tu CSS va aquí, es muy extenso para pegarlo todo */
        .question-list { background: var(--card-background); border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .question-item { margin-bottom: 32px; padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.4s ease; }
        .question-number { color: var(--primary-color); font-weight: 600; margin-bottom: 12px; }
        .answer { color: var(--secondary-color); opacity: 0; max-height: 0; overflow: hidden; transition: all 0.5s ease; font-weight: 600; }
        .answer.show { opacity: 1; max-height: 120px; margin-top: 16px; padding: 16px; border-radius: 10px; border-left: 4px solid var(--secondary-color); background: rgba(255, 112, 67, 0.1); }
        .reveal-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.4s ease; }
        .reveal-btn.hide { background: var(--secondary-color); }
        .action-buttons { margin-top: 16px; }
        .navigation { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: none; gap: 12px; background: rgba(255,255,255,0.95); padding: 12px; border-radius: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
        .navigation.show { display: flex; }
        .nav-btn { background: var(--button-bg); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; }
        /* ... el resto de tu CSS ... */
    </style>
</head>
<body>

    <!-- Contenedor de Autenticación -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <h2 id="authTitle">Iniciar Sesión</h2>
            <input type="email" id="email" placeholder="Correo electrónico" required>
            <input type="password" id="password" placeholder="Contraseña" required>
            <button id="authButton">Iniciar Sesión</button>
            <p id="authError" style="color: red; margin-top: 10px;"></p> <!-- Para mostrar errores -->
            <p class="auth-toggle">
                ¿No tienes cuenta? <a href="#" id="toggleLink">Regístrate</a>
            </p>
        </div>
    </div>

    <!-- Contenido principal de la App (oculto por defecto) -->
    <div id="appContent" style="display: none;">
        <header class="main-header">
            <h1 class="main-title">Temari Oposicions</h1>
            <p>Usuario: <span id="userEmail"></span></p>
            <button id="logoutBtn" class="logout-btn">Cerrar Sesión</button>
        </header>

        <main class="quiz-container">
            <div class="question-list" id="questionList">
                <!-- Las preguntas se cargarán aquí dinámicamente -->
            </div>
        </main>
        
        <nav class="navigation">
            <button class="nav-btn" id="prevBtn">← Anterior</button>
            <button class="nav-btn" id="nextBtn">Siguiente →</button>
        </nav>
    </div>

    <script type="module">
        // Importa las funciones necesarias del SDK de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";

        // Tu configuración de la aplicación web de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBwBaThAwh-QDyH9XQDY4Ef03LMX9z4xXM", // Tu API Key
            authDomain: "temari-oposicions.firebaseapp.com",
            projectId: "temari-oposicions",
            storageBucket: "temari-oposicions.appspot.com", // Corregido
            messagingSenderId: "795136368588",
            appId: "1:795136368588:web:359df54bb55555275ac769",
            measurementId: "G-V3QL2VWYPT"
        };
        
        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- ELEMENTOS DEL DOM ---
        const authContainer = document.getElementById('authContainer');
        const appContent = document.getElementById('appContent');
        const authTitle = document.getElementById('authTitle');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authButton = document.getElementById('authButton');
        const toggleLink = document.getElementById('toggleLink');
        const logoutBtn = document.getElementById('logoutBtn');
        const authError = document.getElementById('authError');
        const userEmailSpan = document.getElementById('userEmail');

        let isLogin = true;

        // --- LÓGICA DE AUTENTICACIÓN ---

        // Cambiar entre modo Login y Registro
        toggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            authError.textContent = ''; // Limpiar errores al cambiar
            authTitle.textContent = isLogin ? 'Iniciar Sesión' : 'Registrarse';
            authButton.textContent = isLogin ? 'Iniciar Sesión' : 'Registrarse';
            toggleLink.innerHTML = isLogin ? '¿No tienes cuenta? <a href="#">Regístrate</a>' : '¿Ya tienes cuenta? <a href="#">Inicia Sesión</a>';
        });

        // Manejar click en el botón de Login/Registro
        authButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            authError.textContent = ''; // Limpiar errores previos

            if (!email || !password) {
                authError.textContent = 'Por favor, completa todos los campos.';
                return;
            }

            if (isLogin) {
                // --- Iniciar Sesión ---
                signInWithEmailAndPassword(auth, email, password)
                    .catch((error) => {
                        authError.textContent = "Error: " + error.message;
                    });
            } else {
                // --- Registrar Usuario ---
                createUserWithEmailAndPassword(auth, email, password)
                    .catch((error) => {
                        authError.textContent = "Error al registrar: " + error.message;
                    });
            }
        });

        // Manejar cierre de sesión
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // Observador del estado de autenticación (la parte más importante)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario ha iniciado sesión o se ha registrado
                console.log("Usuario autenticado:", user.email);
                authContainer.style.display = 'none';
                appContent.style.display = 'block';
                document.querySelector('.main-header').classList.add('show');
                document.querySelector('.quiz-container').classList.add('show');
                document.querySelector('.navigation').classList.add('show');
                userEmailSpan.textContent = user.email;
                fetchQuestions(); // Cargar preguntas solo cuando el usuario está logueado
            } else {
                // Usuario ha cerrado sesión o no está logueado
                console.log("Ningún usuario autenticado.");
                authContainer.style.display = 'flex';
                appContent.style.display = 'none';
            }
        });


        // --- LÓGICA DEL QUIZ ---
        async function fetchQuestions() {
            try {
                const response = await fetch('temari.json');
                if (!response.ok) throw new Error('No se pudo cargar el temario.json');
                const questions = await response.json();
                renderQuestions(questions);
            } catch (error) {
                console.error("Error al cargar las preguntas:", error);
                document.getElementById('questionList').innerHTML = `<p style="color:red; text-align:center;">Error al cargar el temario. Asegúrate de que el archivo 'temari.json' exista.</p>`;
            }
        }

        function renderQuestions(questions) {
            const questionList = document.getElementById('questionList');
            questionList.innerHTML = ''; // Limpiar la lista
            questions.forEach(q => {
                const item = document.createElement('div');
                item.className = 'question-item';
                item.innerHTML = `
                    <div class="question-number">${q.id}. ${q.question}</div>
                    <div class="action-buttons">
                        <button class="reveal-btn">🤔 Mostrar respuesta</button>
                    </div>
                    <div class="answer">${q.answer}</div>
                `;
                questionList.appendChild(item);
            });

            // Añadir eventos a los botones recién creados
            document.querySelectorAll('.reveal-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const answer = button.parentElement.nextElementSibling;
                    const isShown = answer.classList.toggle('show');
                    button.textContent = isShown ? '🙈 Ocultar respuesta' : '🤔 Mostrar respuesta';
                    button.classList.toggle('hide', isShown);
                });
            });
        }
        
        // El resto de tu lógica (PWA, modo oscuro, etc.) iría aquí.
        // He simplificado la lógica del quiz para centrarme en el problema de autenticación.
    </script>
</body>
</html>
